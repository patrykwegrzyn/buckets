"use strict";var d=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var V=(l,c)=>{for(var e in c)d(l,e,{get:c[e],enumerable:!0})},b=(l,c,e,n)=>{if(c&&typeof c=="object"||typeof c=="function")for(let t of x(c))!v.call(l,t)&&t!==e&&d(l,t,{get:()=>c[t],enumerable:!(n=h(c,t))||n.enumerable});return l};var m=l=>b(d({},"__esModule",{value:!0}),l);var B={};V(B,{Store:()=>y});module.exports=m(B);var K=require("events"),g=require("lmdbx"),y=class extends K.EventEmitter{constructor(e,n){super();this.dbs=new Map;this.flushing=!1;this.indexes=new Map;this.env=(0,g.open)(e,n),this.ttlBucket=this.env.openDB("ttl",{cache:!0}),this.indexDb=this.env.openDB("index",{cache:!0})}ttlKey(e,n,t){return`${e}:${n}:${t}`}wrapDB(e,n){let t=this,o=Object.create(e);return o.query=async function(s,i){console.log("query",s,i);let r=[],a=t.indexKey(n,s,i);for(let{key:u,value:p}of t.indexDb.getRange({start:a,end:`${a}\xFF`}))console.log({key:u,value:p}),r.push(p);return(await e.getMany(r)).filter(u=>u!==void 0)},o.put=function(s,i,r){let a;if(r&&r.version!==void 0&&r.ifVersion!==void 0?a=e.put(s,i,r.version,r.ifVersion):r&&r.version!==void 0?a=e.put(s,i,r.version):a=e.put(s,i),r?.ttl){let u=Date.now()+r.ttl,p=t.ttlKey(u,n,String(s));t.ttlBucket.put(p,"")}let f=t.indexes.get(n);if(f)for(let u of f){let p=i[u],D=t.indexKey(n,u,p,s);t.indexDb.put(D,String(s))}return r?.quiet||t.emit("change",{op:"put",bucket:n,id:s,value:e.encoder.encode(i),version:r?.version,ttl:r?.ttl}),a},o.remove=function(s,i){let r=t.indexes.get(n);if(r){let a=e.get(s);for(let f of r){let u=a[f],p=t.indexKey(n,f,u,s);t.indexDb.remove(p)}}if(!i?.quiet){let a=e.get(s);t.emit("change",{op:"remove",bucket:n,id:s,value:a,version:i?.ifVersion})}return i?.ifVersion!==void 0?e.remove(s,i.ifVersion):e.remove(s)},o}indexKey(e,n,t,o=""){return`${e}:${n}:${t}:${o}`}bucket(e,n){let t=this.dbs.get(e);if(!t){let o={cache:!0,...n},s=this.env.openDB(e,o);t=this.wrapDB(s,e),n?.indexes&&this.indexes.set(e,n.indexes),this.dbs.set(e,t)}return t}async clean(){if(this.flushing)return;this.flushing=!0;let e=[],n=Date.now().toString();for(let t of this.ttlBucket.getKeys({end:n})){let o=t.split(":");if(o.length<3)continue;let s=o[1],i=o.slice(2).join(":");e.push({ttlKey:t,bucketName:s,id:i})}await this.env.transaction(()=>{for(let{ttlKey:t,bucketName:o,id:s}of e)this.bucket(o).remove(s,{quiet:!0}),this.ttlBucket.remove(t)}),this.flushing=!1}async close(){let e=Array.from(this.dbs.values()).map(n=>n.close());await Promise.all([...e,this.env.close(),this.ttlBucket.close()])}};0&&(module.exports={Store});
//# sourceMappingURL=index.js.map
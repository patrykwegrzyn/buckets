"use strict";var l=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var m=Object.prototype.hasOwnProperty;var v=(u,a)=>{for(var e in a)l(u,e,{get:a[e],enumerable:!0})},y=(u,a,e,s)=>{if(a&&typeof a=="object"||typeof a=="function")for(let t of V(a))!m.call(u,t)&&t!==e&&l(u,t,{get:()=>a[t],enumerable:!(s=D(a,t))||s.enumerable});return u};var h=u=>y(l({},"__esModule",{value:!0}),u);var g={};v(g,{Store:()=>p});module.exports=h(g);var f=require("events"),K=require("lmdb"),p=class extends f.EventEmitter{constructor(e,s){super();this.flushing=!1;this.dbs=new Map,this.env=(0,K.open)(e,s),this.ttlBucket=this.env.openDB("ttl",{cache:!0})}ttlKey(e,s,t){return`${e}:${s}:${t}`}wrapDB(e,s){let t=this,o=Object.create(e);return o.put=function(n,i,r){let c;if(r&&r.version!==void 0&&r.ifVersion!==void 0?c=e.put(n,i,r.version,r.ifVersion):r&&r.version!==void 0?c=e.put(n,i,r.version):c=e.put(n,i),r?.ttl){let b=Date.now()+r.ttl,d=t.ttlKey(b,s,String(n));t.ttlBucket.put(d,"")}return r?.quiet||t.emit("change",{op:"put",bucket:s,id:n,value:e.encoder.encode(i),version:r?.version,ttl:r?.ttl}),c},o.remove=function(n,i){if(!i?.quiet){let r=e.get(n);t.emit("change",{op:"remove",bucket:s,id:n,value:r,version:i?.ifVersion})}return i?.ifVersion!==void 0?e.remove(n,i.ifVersion):e.remove(n)},o}bucket(e,s){let t=this.dbs.get(e);if(!t){let o={cache:!0,...s},n=this.env.openDB(e,o);t=this.wrapDB(n,e),this.dbs.set(e,t)}return t}async clean(){if(this.flushing)return;this.flushing=!0;let e=[],s=Date.now().toString();for(let t of this.ttlBucket.getKeys({end:s})){let o=t.split(":");if(o.length<3)continue;let n=o[1],i=o.slice(2).join(":");e.push({ttlKey:t,bucketName:n,id:i})}await this.env.transaction(()=>{for(let{ttlKey:t,bucketName:o,id:n}of e)this.bucket(o).remove(n,{quiet:!0}),this.ttlBucket.remove(t)}),this.flushing=!1}};0&&(module.exports={Store});
//# sourceMappingURL=index.js.map
"use strict";var b=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var d=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var k=(c,i)=>{for(var e in i)b(c,e,{get:i[e],enumerable:!0})},B=(c,i,e,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of d(i))!V.call(c,t)&&t!==e&&b(c,t,{get:()=>i[t],enumerable:!(n=v(i,t))||n.enumerable});return c};var q=c=>B(b({},"__esModule",{value:!0}),c);var x={};k(x,{Store:()=>p});module.exports=q(x);var h=require("events"),g=require("lmdbx"),p=class extends h.EventEmitter{constructor(e,n){super();this.flushing=!1;this.dbs=new Map,this.env=(0,g.open)(e,n),this.ttlBucket=this.env.openDB("ttl",{cache:!0})}ttlKey(e,n,t){return`${e}:${n}:${t}`}_patch(e,n){let t=e.put.bind(e),r=e.remove.bind(e),l=this;e.put=(s,o,a,f)=>{let u={},y=!1;typeof a=="number"?u.version=a:typeof a=="object"&&a!==null&&(u=a,y=!!a.quiet);let m=t(s,o,u.version,f);if(u.ttl){let D=Date.now()+u.ttl,K=l.ttlKey(D,n,String(s));l.ttlBucket.put(K,"")}return y||l.emit("change",{op:"put",bucket:n,id:s,value:e.encoder.encode(o),version:u.version,ttl:u.ttl}),m},e.remove=async(s,o)=>{let a=!1,f;if(typeof o=="number"?f=o:typeof o=="object"&&o!==null&&(a=!!o.quiet,f=o.ifVersion),!a){let u=e.get(s);l.emit("change",{op:"remove",bucket:n,id:s,value:u,version:f})}return typeof o=="object"&&o!==null&&o.quiet?r(s,f):r(s,o)}}bucket(e,n){let t=this.dbs.get(e);if(!t){let r={cache:!0,...n};t=this.env.openDB(e,r),this.dbs.set(e,t),this._patch(t,e)}return t}async clean(){if(this.flushing)return;this.flushing=!0;let e=[],n=Date.now().toString();for(let t of this.ttlBucket.getKeys({end:n})){let r=t.split(":");if(r.length<3)continue;let l=r[1],s=r.slice(2).join(":");e.push({ttlKey:t,bucketName:l,id:s})}await this.env.transaction(()=>{for(let{ttlKey:t,bucketName:r,id:l}of e)this.bucket(r).remove(l,{quiet:!0}),this.ttlBucket.remove(t)}),this.flushing=!1}};0&&(module.exports={Store});
//# sourceMappingURL=index.js.map
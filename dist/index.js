"use strict";var p=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var m=(u,o)=>{for(var e in o)p(u,e,{get:o[e],enumerable:!0})},v=(u,o,e,t)=>{if(o&&typeof o=="object"||typeof o=="function")for(let s of x(o))!D.call(u,s)&&s!==e&&p(u,s,{get:()=>o[s],enumerable:!(t=K(o,s))||t.enumerable});return u};var b=u=>v(p({},"__esModule",{value:!0}),u);var V={};m(V,{Store:()=>f});module.exports=b(V);var y=require("events"),h=require("lmdbx"),f=class extends y.EventEmitter{constructor(e,t){super();this.dbs=new Map;this.flushing=!1;this.indexes=new Map;this.env=(0,h.open)(e,t),this.ttlBucket=this.env.openDB("ttl",{cache:!0}),this.indexDb=this.env.openDB("index",{cache:!0})}ttlKey(e,t,s){return`${e}:${t}:${s}`}async committed(){return this.env.committed}wrapDB(e,t){let s=Object.create(e);return s.query=async(n,r)=>{let i=[],a=this.indexKey(t,n,r);for(let{value:c}of this.indexDb.getRange({start:a,end:`${a}\xFF`}))i.push(c);return(await e.getMany(i)).filter(c=>c!==void 0)},s.put=(n,r,i)=>{let a;if(i?.version!==void 0&&i.ifVersion!==void 0?a=e.put(n,r,i.version,i.ifVersion):i?.version!==void 0?a=e.put(n,r,i.version):a=e.put(n,r),i?.ttl){let c=Date.now()+i.ttl,l=this.ttlKey(c,t,String(n));this.ttlBucket.put(l,"")}let d=this.indexes.get(t);if(d)for(let c of d){let l=r[c],g=this.indexKey(t,c,l,n);this.indexDb.put(g,String(n))}return i?.quiet||this.emit("change",{op:"put",bucket:t,id:n,value:e.encoder.encode(r),version:i?.version,ttl:i?.ttl}),a},s.remove=(n,r)=>{let i=e.get(n),a=this.indexes.get(t);if(a&&i)for(let d of a){let c=i[d],l=this.indexKey(t,d,c,n);this.indexDb.remove(l)}return r?.quiet||this.emit("change",{op:"remove",bucket:t,id:n,value:i,version:r?.ifVersion}),r?.ifVersion!==void 0?e.remove(n,r.ifVersion):e.remove(n)},s}indexKey(e,t,s,n){return[e,t,s,n].filter(r=>r!==void 0).join(":")}bucket(e,t){let s=this.dbs.get(e);if(!s){let n={cache:!0,...t},r=this.env.openDB(e,n);s=this.wrapDB(r,e),t?.indexes&&this.indexes.set(e,t.indexes),this.dbs.set(e,s)}return s}async clean(){if(this.flushing)return;this.flushing=!0;let e=[],t=Date.now().toString();for(let s of this.ttlBucket.getKeys({end:t})){let n=s.split(":");if(n.length<3)continue;let r=n[1],i=n.slice(2).join(":");e.push({ttlKey:s,bucketName:r,id:i})}await this.env.transaction(()=>{for(let{ttlKey:s,bucketName:n,id:r}of e)this.bucket(n).remove(r,{quiet:!0}),this.ttlBucket.remove(s)}),this.flushing=!1}async close(){let e=Array.from(this.dbs.values()).map(t=>t.close());await Promise.all([...e,this.env.close(),this.ttlBucket.close()])}};0&&(module.exports={Store});
//# sourceMappingURL=index.js.map